# Copyright 2025 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

dynamo:
  namespace: dynamo-cloud
  releaseVersion: "0.7.0"
  deploymentName:
  computeDomain:
    name: yijiaj-a4x-domain
    numNodes: 4
    resourceClaimTemplateName: yijiaj-a4x-channel
  frontend:
    image: nvcr.io/nvidia/ai-dynamo/sglang-runtime:0.6.1
    replicas: 1
    livenessProbe:
      initialDelaySeconds: 3000
      periodSeconds: 60
      timeoutSeconds: 150
      failureThreshold: 100
    readinessProbe:
      initialDelaySeconds: 3000
      periodSeconds: 60
      timeoutSeconds: 300
      failureThreshold: 100
  decodeWorker:
    image: us-central1-docker.pkg.dev/linglinll-gke-dev/dynamo/dynamo-base:dynamo-wideep-gb200-v0.6.1
    nodeCount: 2
    replicas: 1
    envs:
    - name: LD_LIBRARY_PATH
      value: "/usr/local/ucx/lib:/usr/local/ucx/lib/ucx:/opt/nvidia/nvda_nixl/lib/aarch64-linux-gnu:/opt/nvidia/nvda_nixl/lib/aarch64-linux-gnu/plugins:/usr/local/nvidia/lib64"
    - name: GLOO_SOCKET_IFNAME
      value: eth0
    - name: TP_SOCKET_IFNAME
      value: eth0
    - name: SGLANG_ENABLE_JIT_DEEPGEMM
      value: "1"
    - name: DYN_SKIP_SGLANG_LOG_FORMATTING
      value: "1"
    - name: MC_TE_METRIC
      value: "true"
    - name: SGLANG_ENABLE_FLASHINFER_GEMM
      value: "1"
    - name: SGLANG_DISAGGREGATION_HEARTBEAT_MAX_FAILURE
      value: "100000"
    - name: SGLANG_DISAGGREGATION_BOOTSTRAP_TIMEOUT
      value: "100000"
    - name: SGLANG_DISAGGREGATION_WAITING_TIMEOUT
      value: "100000"
    - name: SGLANG_DECODE_BOOTSTRAP_TIMEOUT
      value: "1000"
    - name: SGLANG_HACK_SEQ_BOOTSTRAP_ROOM
      value: "1"
    - name: SGLANG_MOONCAKE_CUSTOM_MEM_POOL
      value: "True"
    - name: MC_FORCE_MNNVL
      value: "1"
    - name: NCCL_MNNVL_ENABLE
      value: "1"
    - name: NCCL_CUMEM_ENABLE
      value: "1"
    - name: SGLANG_USE_MESSAGE_QUEUE_BROADCASTER
      value: "0"
    - name: SGLANG_DISABLE_TP_MEMORY_INBALANCE_CHECK
      value: "1"
    - name: PYTHONUNBUFFERED
      value: "1"
    - name: NCCL_DEBUG
      value: INFO
    - name: NCCL_DEBUG_SUBSYS
      value: INIT,BOOTSTRAP,ENV,NET,GRAPH
    - name: NCCL_SOCKET_FAMILY
      value: "AF_INET"
    - name: GLOO_SOCKET_FAMILY
      value: "AF_INET"
    livenessProbe:
      initialDelaySeconds: 3000
      periodSeconds: 60
      timeoutSeconds: 150
      failureThreshold: 100
    readinessProbe:
      initialDelaySeconds: 3000
      periodSeconds: 60
      timeoutSeconds: 300
      failureThreshold: 100
    startupProbe:
      initialDelaySeconds: 3000
      periodSeconds: 60
      timeoutSeconds: 600
      failureThreshold: 3000
  prefillWorker:
    image: us-central1-docker.pkg.dev/linglinll-gke-dev/dynamo/dynamo-base:dynamo-wideep-gb200-v0.6.1
    nodeCount: 2
    replicas: 1
    envs:
      - name: LD_LIBRARY_PATH
        value: "/usr/local/ucx/lib:/usr/local/ucx/lib/ucx:/opt/nvidia/nvda_nixl/lib/aarch64-linux-gnu:/opt/nvidia/nvda_nixl/lib/aarch64-linux-gnu/plugins:/usr/local/nvidia/lib64"
      - name: UCX_TLS
        value: "^tcp"
      - name: GLOO_SOCKET_IFNAME
        value: eth0
      - name: TP_SOCKET_IFNAME
        value: eth0
      - name: SGLANG_ENABLE_JIT_DEEPGEMM
        value: "1"
      - name: DYN_SKIP_SGLANG_LOG_FORMATTING
        value: "1"
      - name: MC_TE_METRIC
        value: "true"
      - name: SGLANG_ENABLE_FLASHINFER_GEMM
        value: "1"
      - name: SGLANG_DISAGGREGATION_HEARTBEAT_MAX_FAILURE
        value: "100000"
      - name: SGLANG_DISAGGREGATION_BOOTSTRAP_TIMEOUT
        value: "100000"
      - name: SGLANG_DISAGGREGATION_WAITING_TIMEOUT
        value: "100000"
      - name: SGLANG_MOONCAKE_CUSTOM_MEM_POOL
        value: "True"
      - name: MC_FORCE_MNNVL
        value: "1"
      - name: NCCL_MNNVL_ENABLE
        value: "1"
      - name: NCCL_CUMEM_ENABLE
        value: "1"
      - name: SGLANG_USE_MESSAGE_QUEUE_BROADCASTER
        value: "0"
      - name: SGLANG_DISABLE_TP_MEMORY_INBALANCE_CHECK
        value: "1"
      - name: PYTHONUNBUFFERED
        value: "1"
    livenessProbe:
      initialDelaySeconds: 3000
      periodSeconds: 60
      timeoutSeconds: 150
      failureThreshold: 100
    readinessProbe:
      initialDelaySeconds: 3000
      periodSeconds: 60
      timeoutSeconds: 300
      failureThreshold: 100
    startupProbe:
      initialDelaySeconds: 3000
      periodSeconds: 60
      timeoutSeconds: 600
      failureThreshold: 3000
 

secrets:
  ngc:
    secretName: nvcr-secret
  huggingface:
    secretName: hf-token-secret
    secretData:
      token: "hf_api_token"

volumes:
  gcsfuse:
    bucketName: "yijiaj-test"
    fileCacheCapacity: "500G"
    cachePath: "/gcs-cache"
  ssdMountPath: "/ssd"
  gcsMounts:
    - bucketName:  "yijiaj-test"
      mountPath: "/data/model"

service:
  type: ClusterIP
  ports:
    frontend: 8000
    worker: 9090

workload:
  model: deepseek-ai/DeepSeek-R1
  gpus: 16
  framework: sglang

network:
  subnetworks: []
  gibVersion: us-docker.pkg.dev/gce-ai-infra/gpudirect-gib/nccl-plugin-gib-diagnostic-arm64:v1.0.7
  ncclSettings:
    - name: NCCL_DEBUG
      value: "VERSION"

quantizations:
  - "fp8"
